'use strict';
var test = require('tape');

// https://code.google.com/p/selenium/wiki/WebDriverJs
var webdriver = require('selenium-webdriver');
var chrome = require('selenium-webdriver/chrome');
var firefox = require('selenium-webdriver/firefox');

// A helper function to query stats from a PeerConnection.
function getStats(driver, peerConnection) {
  // Execute getStats on peerconnection named `peerConnection`.
  console.log('getStats');
  driver.manage().timeouts().setScriptTimeout(1000);
  return driver.executeAsyncScript(
      'var callback = arguments[arguments.length - 1];' +
      peerConnection + '.getStats(null, function(report) {' +
      '  callback(report);' +
      '});');
}

function buildDriver(browser) {
    // Firefox options.
    // http://selenium.googlecode.com/git/docs/api/javascript/module_selenium-webdriver_firefox.html
    var profile = new firefox.Profile();
    profile.setPreference('media.navigator.streams.fake', true);
    var firefoxOptions = new firefox.Options()
        .setBinary('./wrap.sh')
        .setProfile(profile);
    // Chrome options.
    // http://selenium.googlecode.com/git/docs/api/javascript/module_selenium-webdriver_chrome_class_Options.html#addArguments
    var chromeOptions = new chrome.Options()
    .addArguments('enable-logging=1')
    .addArguments('v=1')
    .addArguments('vmodule=*libjingle/source/talk/*=4')
    .addArguments('user-data-dir=/tmp/somechrome/')
    .addArguments('allow-file-access-from-files')
    .addArguments('use-fake-device-for-media-stream')
    .addArguments('use-fake-ui-for-media-stream');
    // use-file-for-fake-audio-capture -- see https://code.google.com/p/chromium/issues/detail?id=421054

  return new webdriver.Builder()
      .forBrowser(browser || process.env.BROWSER || 'firefox')
      .setFirefoxOptions(firefoxOptions)
      .setChromeOptions(chromeOptions)
      .build();
}

function doJoin(driver, room) {
    return driver.get('https://localhost/simplewebrtc/?' + room);
    //return driver.get('https://simplewebrtc.com/demo.html?' + room);
}

function test2(browserA, browserB, t) {
    var room = 'testing_' + Math.floor(Math.random()*100000);

    var userA = buildDriver(browserA);
    doJoin(userA, room);

    var userB = buildDriver(browserB);
    doJoin(userB, room);

    userA.sleep(5*1000);
    getStats(userA, 'webrtc.getPeers()[0].pc.pc')
    .then(function (stats) {
        console.log(stats);
    });
    userA.wait(function () {
        return userA.executeScript('return (function() {' +
            'var connected = 0;' + 
            'webrtc.getPeers().forEach(function (peer) {' +
            '  if (peer.pc.iceConnectionState === \'connected\' || peer.pc.iceConnectionState === \'completed\') connected++;' + 
            '});' +
            'return connected === 1;' +
            '})()');
    }, 1*1000)
    .then(function () {
        ok++;
        console.log(ok, fail);
        t.pass('Mesh connected');
        userA.quit();
        userB.quit().then(function () {
            t.end();
        });
    })
    .then(null, function (err) {
        fail++;
        console.log(ok, fail);
        t.pass('Mesh failed');
    })
    .then(null, function (err) {
        userA.quit();
        userB.quit().then(function () {
            t.end();
        });
    });
}

var ok = 0; 
var fail = 0;
// test is flaky
for (var i = 0; i < 1; i++) {
    test('Mesh, Chrome-Firefox-Firefox', function (t) {
        test2('chrome', 'firefox', t);
        //test2('firefox', 'chrome', t);
        //test2('firefox', 'firefox', t);
        //test2('chrome', 'chrome', t);
        //test2('firefox', 'firefox', t);
    });
}
test('results', function (t) {
    console.log('RESULTS', ok, fail);
    t.end();
});
