'use strict';
var test = require('tape');

// https://code.google.com/p/selenium/wiki/WebDriverJs
var webdriver = require('selenium-webdriver');
var firefox = require('selenium-webdriver/firefox');
var chrome = require('selenium-webdriver/chrome');

function buildDriver(browser) {
    // Firefox options.
    // http://selenium.googlecode.com/git/docs/api/javascript/module_selenium-webdriver_firefox.html
    var profile = new firefox.Profile();
    profile.setPreference('media.navigator.streams.fake', true);
    var firefoxOptions = new firefox.Options()
        .setProfile(profile);

    // Chrome options.
    // http://selenium.googlecode.com/git/docs/api/javascript/module_selenium-webdriver_chrome_class_Options.html#addArguments
    var chromeOptions = new chrome.Options()
        /*
        .addArguments('enable-logging=1')
        .addArguments('v=1')
        .addArguments('vmodule=*libjingle/source/talk/*=4')
        .addArguments('user-data-dir=/some/where')
        */
        .addArguments('allow-file-access-from-files')
        .addArguments('use-fake-device-for-media-stream')
        .addArguments('use-fake-ui-for-media-stream');
        // use-file-for-fake-audio-capture -- see https://code.google.com/p/chromium/issues/detail?id=421054

  return new webdriver.Builder()
      .forBrowser(browser || process.env.BROWSER || 'firefox')
      .setFirefoxOptions(firefoxOptions)
      .setChromeOptions(chromeOptions)
      .build();
}

function doJoin(driver, room) {
    return driver.get('https://simplewebrtc.com/audio?' + room);
}

function testP2P(browserA, browserB, t) {
    var room = 'testing_' + Math.floor(Math.random()*100000);

    var userA = buildDriver(browserA);
    doJoin(userA, room);

    var userB = buildDriver(browserB);
    doJoin(userB, room);

    userA.wait(function () {
        return userA.executeScript('return webrtc.getPeers().length === 1 ' + 
            '&& (webrtc.getPeers()[0].pc.iceConnectionState === \'connected\' || webrtc.getPeers()[0].pc.iceConnectionState === \'completed\');'); 
    }, 30*1000)
    .then(function () {
        t.pass('P2P connected');
        userA.quit();
        userB.quit().then(function () {
            t.end();
        });
    })
    .then(null, function (err) {
        t.fail(err);
        userA.quit();
        userB.quit();
    });
}

test('P2P, Chrome-Chrome', function (t) {
    testP2P('chrome', 'chrome', t);
});
